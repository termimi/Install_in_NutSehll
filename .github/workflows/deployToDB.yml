name: Deploy Script to DB

on:
  push:
    branches:
    - main
jobs:
  check-commit-message:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Récupération du message de commit
      - name: Get Commit Message
        id: get_commit
        run: |
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B)" >> $GITHUB_ENV

      # Exécution conditionnelle
      - name: Run Workflow if Commit Contains 'feat'
        if: contains(env.COMMIT_MESSAGE, 'feat')
        run: |
          echo "This commit contains 'feat'. Running the workflow..."
          echo "Running=true" >> $GITHUB_ENV
          
      - name: Install MySQl Client
        if: ${{ env.RUNNING == 'true' }} 
        run: |
          cd localDB
          sudo apt update
          sudo apt upgrade -y
          sudo apt install -y mysql-client
          mysql --version
        
      - name: Push Script to DB
        env:
          MYSQL_USERNAME: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_HOST: ${{secrets.MYSQL_HOST}}
        run: |
          pwd
          ls
          pwd
          mysql -h $MYSQL_HOST -u $MYSQL_USERNAME -p$MYSQL_PASSWORD -e "SELECT LOAD_FILE('/home/runner/work/Install_in_NutShell/Install_in_NutShell/localDb/install_in_nutshell.ps1');"
          mysql -h $MYSQL_HOST -u $MYSQL_USERNAME -p$MYSQL_PASSWORD -e "CREATE DATABASE IF NOT EXISTS install_in_nutShell;"
          mysql -h $MYSQL_HOST -u $MYSQL_USERNAME -p$MYSQL_PASSWORD -D install_in_nutShell -e "INSERT INTO Script_file (nom, contenu) VALUES ('install_in_nutshell.ps1', LOAD_FILE('/home/runner/work/Install_in_NutShell/Install_in_NutShell/localDb/install_in_nutshell.ps1'));"
          

      
        
